name: Homebrew test-bot

on:
  pull_request:
  push:

jobs:
  test-bot:
    name: ${{ matrix.os }}
    runs-on: ${{ matrix.os }}

    strategy:
      fail-fast: false
      matrix:
        os: [macos-latest, ubuntu-latest]

    env:
      HOMEBREW_NO_ANALYTICS: "1"
      HOMEBREW_NO_AUTO_UPDATE: "1"
      HOMEBREW_NO_INSTALL_CLEANUP: "1"

      # Arbitrary local tap name for the PR workspace
      TAP_NAME: "ci/localtap"

    steps:
      - name: Checkout (PR contents)
        uses: actions/checkout@v4

      - name: Set up Homebrew
        uses: Homebrew/actions/setup-homebrew@master

      # Register the PR workspace as a tap
      - name: Tap workspace
        run: |
          brew tap --force-auto-update "$TAP_NAME" "$GITHUB_WORKSPACE"
          brew tap | grep -F "$TAP_NAME"

      # Run the full Homebrew pipeline
      - name: Run brew test-bot
        run: |
          brew test-bot \
            --tap="$TAP_NAME" \
            --only-formulae \
            --root-url="https://example.invalid"
