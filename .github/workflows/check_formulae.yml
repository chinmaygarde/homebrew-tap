name: Check Formulae

on:
  push:
  pull_request:

jobs:
  test-formula:
    name: ${{ matrix.os }} / ${{ matrix.formula }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os:
          - macos-latest
          - ubuntu-latest
        formula:
          - doxygen2docset
    env:
      HOMEBREW_NO_ANALYTICS: "1"
      HOMEBREW_NO_INSTALL_CLEANUP: "1"
      HOMEBREW_NO_AUTO_UPDATE: "1"

    steps:
      - name: Checkout tap repository
        uses: actions/checkout@v4

      - name: Set up Homebrew
        uses: Homebrew/actions/setup-homebrew@master

      - name: Show Homebrew config
        run: |
          brew --version
          brew config

      - name: Tap this repository
        run: |
          brew tap --force-auto-update "$GITHUB_REPOSITORY" "$GITHUB_WORKSPACE"

      - name: Audit formula
        run: |
          brew audit --formula --strict "$GITHUB_REPOSITORY/${{ matrix.formula }}"

      - name: Install formula
        run: |
          brew install --verbose --debug "$GITHUB_REPOSITORY/${{ matrix.formula }}"

      - name: Run formula test
        run: |
          brew test "$GITHUB_REPOSITORY/${{ matrix.formula }}"
